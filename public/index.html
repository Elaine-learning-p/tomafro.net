<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html>
<head>
  <title>Tom Ward's blog &middot; tomafro.net</title>
  <meta name="description" content="Personal blog of Tom Ward, in which he writes about ruby, rails and web development, as well as other random ephemera"/>
  <meta name="verify-v1" content="ADnFYWq1MeVbf8+qNPe/GZTvcEsDgOCgWTWrUIPakz8=" />
  <meta http-equiv="X-UA-Compatible" content="chrome=1" />
  <script type="text/javascript" src="http://use.typekit.com/brv6igt.js"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  <link rel="stylesheet" href="/css/style.css" type="text/css" />
  <link rel="alternate" type="application/atom+xml" href="http://tomafro.net/atom.xml" />
  <link rel="canonical" href="http://tomafro.net"/>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1103395-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script');
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 
          'http://www') + '.google-analytics.com/ga.js';
      ga.setAttribute('async', 'true');
      document.documentElement.firstChild.appendChild(ga);
    })();
  </script>
  
</head>
<body>  
  <div id="container">
    <header class="menubar">
      <a class="name" href="/">tomafro.net</a> &middot; <a href="/about">about</a> &middot; <a href="http://github.com/tomafro">on github</a> &middot; <a href="http://delicious.com/tomafro">on delicious</a> &middot; <a href="http://twitter.com/tomafro">on twitter</a> &middot; <a href="http://www.last.fm/user/tomafro">on last.fm</a>
    </header>
    <div id="main">
      
<article class="post">
  <div class="content"><h2 class="title"><a href="/2011/03/hashblue-opens-for-business">#blue opens for business</a></h2>
    <p>If you're an <a href="http://o2.co.uk">O2</a> customer based in the UK, you might be interested that <a href="https://hashblue.com">#blue</a>, a project <a href="http://gofreerange.com">we've built</a>, has recently (re)opened for business.  It's a soft launch, but feel free to tell your friends.</p>

<p><a href="https://hashblue.com">#blue</a> gets copies of every SMS message you send or receive, and makes them available to you on the web.  You can search your messages, read whole conversations, and even reply, all from the comfort of your browser.</p>

<div class="screenshot">
<img src="/images/20110303-hashblue-messages.png"/>
</div>


<p>As well as a nice-looking web UI, there's also <a href="https://api.hashblue.com">an API</a> that allows other apps to read and manipulate your messages and contacts (once you give them permission). Think automatic posting to twitter, or showing new messages as alerts on your desktop.  The possibilities are endless.</p>

<div class="screenshot">
<img src="/images/20110303-hashblue-api.png"/>
</div>


<p>Oh, and it's all free.  All you need is an <a href="http://o2.co.uk">O2</a> phone.</p>

<p>If you think it sounds interesting, <a href="https://hashblue.com/">ask for a beta request</a>.  You should get an invitation very quickly.  Once on board, please send me any suggestions and feedback.  It's going to be interesting to see where we can take this project.</p>

  </div>
  <div class="meta">
  <span class="author"><a href="http://tomafro.net">Tom Ward</a></span> &middot; 
  <span class="date"><a href="/2011/03"> 3rd March 2011</a></span>
  <span class="tags"> &middot; <a href="/tags/hashblue" rel="tag">hashblue</a> &middot; <a href="/tags/gofreerange" rel="tag">gofreerange</a> &middot; <a href="/tags/o2" rel="tag">o2</a></span>
  </div>
</article>

<article class="post">
  <div class="content"><h2 class="title"><a href="/2011/02/rails-mongo-instrumentation-gem">Mongo instrumentation released as a gem</a></h2>
    <p>Enough people seemed to comment and like the mongo instrumentation code I wrote about yesterday that I've packaged it up and released it as a gem.</p>

<p>The <a href="http://rubygems.org/gems/mongo-rails-instrumentation">mongo-rails-instrumentation</a> gem is available on rubygems, and the code is <a href="https://github.com/tomafro/mongo-rails-instrumentation">up on github</a>.</p>

<p>Adding it to a project is simple, just put the following in your <code>Gemfile</code>, run <code>bundle install</code> and restart your app.</p>

<div class="highlight"><pre>    <span class="n">gem</span> <span class="s1">&#39;mongo-rails-instrumentation&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt;0.1&#39;</span>
</pre>
</div>


<p>Please add any suggestions, improvements and comments to the code in github.  I hope people find it useful.</p>

  </div>
  <div class="meta">
  <span class="author"><a href="http://tomafro.net">Tom Ward</a></span> &middot; 
  <span class="date"><a href="/2011/02">19th February 2011</a></span>
  <span class="tags"> &middot; <a href="/tags/ruby" rel="tag">ruby</a> &middot; <a href="/tags/rails" rel="tag">rails</a> &middot; <a href="/tags/rails3" rel="tag">rails3</a> &middot; <a href="/tags/mongo" rel="tag">mongo</a> &middot; <a href="/tags/instrumentation" rel="tag">instrumentation</a></span>
  </div>
</article>

<article class="post">
  <div class="content"><h2 class="title"><a href="/2011/02/experimental-mongo-instrumentation">Experimental Mongo instrumentation (for Rails 3)</a></h2>
    <div class="update">
Update: Changed to instrument methods on the Mongo::Connection
</div>


<p>One of our latest rails projects uses <a href="http://mongodb.org">Mongo</a> as a backend.  We're just starting to get some traffic, and as we do, we're monitoring the logs for slow requests.  When using ActiveRecord, rails splits out the recorded request time like so:</p>

<div class="highlight"><pre>    Completed 200 OK in 6ms (Views 370.5ms | ActiveRecord: 2.3ms)
</pre>
</div>


<p>We wanted to do the same for our Mongo accesses, just to give a rough idea as to what our requests were doing.  Luckily Rails 3 makes this relatively straightforward, providing hooks to instrument methods, subscribe to log messages and add information to the request log.  Here, then, is my first stab (mainly harvested from ActiveRecord):</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">Mongo</span>
  <span class="k">module</span> <span class="nn">Instrumentation</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">instrument</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="o">*</span><span class="nb">methods</span><span class="p">)</span>
      <span class="n">clazz</span><span class="o">.</span><span class="n">module_eval</span> <span class="k">do</span>
        <span class="nb">methods</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
          <span class="nb">class_eval</span> <span class="sx">%{def </span><span class="si">#{</span><span class="n">m</span><span class="si">}</span><span class="sx">_with_instrumentation(*args, &amp;block)</span>
<span class="sx">            ActiveSupport::Notifications.instrumenter.instrument &quot;mongo.mongo&quot;, :name =&gt; &quot;</span><span class="si">#{</span><span class="n">m</span><span class="si">}</span><span class="sx">&quot; do</span>
<span class="sx">              </span><span class="si">#{</span><span class="n">m</span><span class="si">}</span><span class="sx">_without_instrumentation(*args, &amp;block)</span>
<span class="sx">            end</span>
<span class="sx">          end</span>
<span class="sx">          }</span>

          <span class="n">alias_method_chain</span> <span class="n">m</span><span class="p">,</span> <span class="ss">:instrumentation</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Railtie</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Railtie</span>
      <span class="n">initializer</span> <span class="s2">&quot;mongo.instrumentation&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>
        <span class="no">Mongo</span><span class="o">::</span><span class="no">Instrumentation</span><span class="o">.</span><span class="n">instrument</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Connection</span><span class="p">,</span> <span class="ss">:send_message</span><span class="p">,</span> <span class="ss">:send_message_with_safe_check</span><span class="p">,</span> <span class="ss">:receive_message</span>

        <span class="no">ActiveSupport</span><span class="o">.</span><span class="n">on_load</span><span class="p">(</span><span class="ss">:action_controller</span><span class="p">)</span> <span class="k">do</span>
          <span class="kp">include</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Instrumentation</span><span class="o">::</span><span class="no">ControllerRuntime</span>
        <span class="k">end</span>

        <span class="no">Mongo</span><span class="o">::</span><span class="no">Instrumentation</span><span class="o">::</span><span class="no">LogSubscriber</span><span class="o">.</span><span class="n">attach_to</span> <span class="ss">:mongo</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">module</span> <span class="nn">ControllerRuntime</span>
      <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

      <span class="kp">protected</span>

      <span class="n">attr_internal</span> <span class="ss">:mongo_runtime</span>

      <span class="k">def</span> <span class="nf">cleanup_view_runtime</span>
        <span class="n">mongo_rt_before_render</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Instrumentation</span><span class="o">::</span><span class="no">LogSubscriber</span><span class="o">.</span><span class="n">reset_runtime</span>
        <span class="n">runtime</span> <span class="o">=</span> <span class="k">super</span>
        <span class="n">mongo_rt_after_render</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Instrumentation</span><span class="o">::</span><span class="no">LogSubscriber</span><span class="o">.</span><span class="n">reset_runtime</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">mongo_runtime</span> <span class="o">=</span> <span class="n">mongo_rt_before_render</span> <span class="o">+</span> <span class="n">mongo_rt_after_render</span>
        <span class="n">runtime</span> <span class="o">-</span> <span class="n">mongo_rt_after_render</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">append_info_to_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">super</span>
        <span class="n">payload</span><span class="o">[</span><span class="ss">:mongo_runtime</span><span class="o">]</span> <span class="o">=</span> <span class="n">mongo_runtime</span>
      <span class="k">end</span>

      <span class="k">module</span> <span class="nn">ClassMethods</span>
        <span class="k">def</span> <span class="nf">log_process_action</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
          <span class="n">messages</span><span class="p">,</span> <span class="n">mongo_runtime</span> <span class="o">=</span> <span class="k">super</span><span class="p">,</span> <span class="n">payload</span><span class="o">[</span><span class="ss">:mongo_runtime</span><span class="o">]</span>
          <span class="n">messages</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="s2">&quot;Mongo: %.1fms&quot;</span> <span class="o">%</span> <span class="n">mongo_runtime</span><span class="o">.</span><span class="n">to_f</span><span class="p">)</span> <span class="k">if</span> <span class="n">mongo_runtime</span>
          <span class="n">messages</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">LogSubscriber</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">LogSubscriber</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">runtime</span><span class="o">=</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">[</span><span class="s2">&quot;mongo_mongo_runtime&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">runtime</span>
        <span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">[</span><span class="s2">&quot;mongo_mongo_runtime&quot;</span><span class="o">]</span> <span class="o">||=</span> <span class="mi">0</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">reset_runtime</span>
        <span class="n">rt</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">rt</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">mongo</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">runtime</span> <span class="o">+=</span> <span class="n">event</span><span class="o">.</span><span class="n">duration</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>It looks complicated, but it's actually pretty simple.  Data access methods in <strike><code>Mongo::DB</code> and <code>Mongo::Collection</code></strike> <code>Mongo::Connection</code> are hijacked and surrounded by an <code>ActiveSupport::Notifications.instrumenter.instrument</code> block.  This triggers events which are listened to by the <code>LogSubscriber</code>, summing the total time spent in Mongo.  The <code>ControllerRuntime</code> then collects this count to be displayed, and resets the sum to zero ready for the next request.  The output looks like this:</p>

<div class="highlight"><pre>    Completed 200 OK in 838ms (Views: 370.5ms | ActiveRecord: 2.3ms | Mongo: 441.5ms)
</pre>
</div>


<p>It's just a first stab, so any comments and improvements are more then welcome.  It's <a href="https://gist.github.com/833444">here on gist</a> so please fork away.</p>

  </div>
  <div class="meta">
  <span class="author"><a href="http://tomafro.net">Tom Ward</a></span> &middot; 
  <span class="date"><a href="/2011/02">18th February 2011</a></span>
  <span class="tags"> &middot; <a href="/tags/ruby" rel="tag">ruby</a> &middot; <a href="/tags/rails" rel="tag">rails</a> &middot; <a href="/tags/rails3" rel="tag">rails3</a> &middot; <a href="/tags/mongo" rel="tag">mongo</a> &middot; <a href="/tags/instrumentation" rel="tag">instrumentation</a></span>
  </div>
</article>

<article class="post">
  <div class="content"><h2 class="title"><a href="/2011/02/rails-3-column-reader-tweak">A home for my Active Record column reader</a></h2>
    <p><a href="http://twitter.com/kraykray">@kraykray</a> was nice enough to let me know that Rails 3.03 had broken my column-reader code.</p>

<p>I've always seen it as a toy rather than a serious project, but getting a bug report made me re-evaluate.  If people are using it, even a tiny piece of code like this deserves a proper home.</p>

<p>So here it is, as both <a href="https://github.com/tomafro/rails-activerecord-columnreader">a github repository</a> and <a href="http://rubygems.org/gems/activerecord-column-reader">a gem</a>.  Enjoy!</p>

  </div>
  <div class="meta">
  <span class="author"><a href="http://tomafro.net">Tom Ward</a></span> &middot; 
  <span class="date"><a href="/2011/02"> 8th February 2011</a></span>
  <span class="tags"> &middot; <a href="/tags/ruby" rel="tag">ruby</a> &middot; <a href="/tags/rails" rel="tag">rails</a> &middot; <a href="/tags/rails3" rel="tag">rails3</a> &middot; <a href="/tags/active-record" rel="tag">active-record</a> &middot; <a href="/tags/column-reader" rel="tag">column-reader</a></span>
  </div>
</article>

<article class="post">
  <div class="content"><h2 class="title"><a href="/2010/02/updated-rails-template-for-bundler">An updated rails template for gem bundler</a></h2>
    <div class="update">
<h3>Update 8th February 2011:</h3>
Bundler has changed a lot since I wrote these instructions.  Use them at your own risk!
</div>


<p>A few months ago I wrote <a href="http://tomafro.net/2009/11/a-rails-template-for-gem-bundler">a rails template for gem bundler</a>. Since then, bundler has changed a lot, and my template no longer works. <a href="http://github.com/tomafro/dotfiles/raw/master/resources/rails/bundler.rb">Here then is an updated version</a>, based on <a href="http://gist.github.com/302406">this gist</a> from <a href="http://arko.net/">Andre Arko</a>.  Using it, you should be able to get a rails 2.3.5 project working with bundler in less than 5 minutes.</p>

<p>The first step is to install the latest bundler.  At the time of writing, this was 0.9.9.</p>

<div class="highlight"><pre><span class="n">gem</span> <span class="n">install</span> <span class="n">bundler</span>
</pre>
</div>


<p>Now you should be able to run the template, either on a new project, or on an existing rails 2.3.5 project.</p>

<div class="highlight"><pre>rails -m http://github.com/tomafro/dotfiles/raw/master/resources/rails/bundler.rb &lt;project&gt;
</pre>
</div>


<p>On a fresh project, that should be all you need to do.  On an existing that used an older version of bundler, you'll need to remove the old hooks in <code>config/preinitializer.rb</code> and <code>config/environment.rb</code>, and the <code>gems</code> folder.</p>

<h3>Explaining the template, step by step</h3>


<p>The first step creates the project <code>Gemfile</code>, with rails available in all environments, and ruby-debug included in development.  If the project has other gems, they should be added here, rather than using rails own <code>config.gem</code> mechanism.</p>

<div class="highlight"><pre><span class="n">file</span> <span class="s1">&#39;Gemfile&#39;</span><span class="p">,</span> <span class="sx">%{</span>
<span class="sx">source &#39;http://rubygems.org&#39;</span>

<span class="sx">gem &#39;rails&#39;, &#39;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">STRING</span><span class="si">}</span><span class="sx">&#39;</span>

<span class="sx">group :development do</span>
<span class="sx">  gem &#39;ruby-debug&#39;</span>
<span class="sx">end</span>
<span class="sx">}</span><span class="o">.</span><span class="n">strip</span>
</pre>
</div>


<p>The next step is get bundler to load correctly.  This is done in two stages.  First, in <code>config\preinitializer.rb</code> bundler needs to be setup.  This adds all the bundled gems to the ruby load path, but doesn't initialise them.</p>

<div class="highlight"><pre>  
<span class="n">append_file</span> <span class="s1">&#39;/config/preinitializer.rb&#39;</span><span class="p">,</span> <span class="sx">%{</span>
<span class="sx">begin</span>
<span class="sx">  # Require the preresolved locked set of gems.</span>
<span class="sx">  require File.expand_path(&#39;../../.bundle/environment&#39;, __FILE__)</span>
<span class="sx">rescue LoadError</span>
<span class="sx">  # Fallback on doing the resolve at runtime.</span>
<span class="sx">  require &quot;rubygems&quot;</span>
<span class="sx">  require &quot;bundler&quot;</span>
<span class="sx">  if Bundler::VERSION &lt;= &quot;0.9.5&quot;</span>
<span class="sx">    raise RuntimeError, &quot;Bundler incompatible.</span><span class="se">\n</span><span class="sx">&quot; +</span>
<span class="sx">      &quot;Your bundler version is incompatible with Rails 2.3 and an unlocked bundle.</span><span class="se">\n</span><span class="sx">&quot; +</span>
<span class="sx">      &quot;Run `gem install bundler` to upgrade or `bundle lock` to lock.&quot;</span>
<span class="sx">  else</span>
<span class="sx">    Bundler.setup</span>
<span class="sx">  end</span>
<span class="sx">end</span>
<span class="sx">}</span><span class="o">.</span><span class="n">strip</span>
</pre>
</div>


<p>Second, the rails boot process is modified to start the bundler environment.  This 'requires' all gems in the bundle, letting them run initialisation code.</p>

<div class="highlight"><pre><span class="n">gsub_file</span> <span class="s1">&#39;config/boot.rb&#39;</span><span class="p">,</span> <span class="s2">&quot;Rails.boot!&quot;</span><span class="p">,</span> <span class="sx">%{</span>
<span class="sx">  </span>
<span class="sx">class Rails::Boot</span>
<span class="sx"> def run</span>
<span class="sx">   load_initializer</span>
<span class="sx">   extend_environment</span>
<span class="sx">   Rails::Initializer.run(:set_load_path)</span>
<span class="sx"> end</span>

<span class="sx"> def extend_environment</span>
<span class="sx">   Rails::Initializer.class_eval do</span>
<span class="sx">     old_load = instance_method(:load_environment)</span>
<span class="sx">     define_method(:load_environment) do</span>
<span class="sx">       Bundler.require :default, Rails.env</span>
<span class="sx">       old_load.bind(self).call</span>
<span class="sx">     end</span>
<span class="sx">   end</span>
<span class="sx"> end</span>
<span class="sx">end</span>

<span class="sx">Rails.boot!</span>
<span class="sx">}</span>
</pre>
</div>


<p>All that's left now is a little cleaning up.  The <code>.bundle</code> folder should never be checked into the code repository as it holds machine-local configuration, so it's added to <code>.gitignore</code>.  Finally, <code>bundle install</code> is run to fetch the bundled gems.</p>

<div class="highlight"><pre><span class="n">append_file</span> <span class="s1">&#39;/.gitignore&#39;</span><span class="p">,</span> <span class="sx">%{</span>
<span class="sx">/.bundle</span>
<span class="sx">}</span>

<span class="n">run</span> <span class="s1">&#39;bundle install&#39;</span>
</pre>
</div>


<p>And that's it.  I hope you find it useful.</p>

  </div>
  <div class="meta">
  <span class="author"><a href="http://tomafro.net">Tom Ward</a></span> &middot; 
  <span class="date"><a href="/2010/02">28th February 2010</a></span>
  <span class="tags"> &middot; <a href="/tags/ruby" rel="tag">ruby</a> &middot; <a href="/tags/rails" rel="tag">rails</a> &middot; <a href="/tags/gem" rel="tag">gem</a> &middot; <a href="/tags/bundler" rel="tag">bundler</a></span>
  </div>
</article>

    </div>
  </div>
</body>	
</html>