<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html>
<head>
  <title>Tom Ward's blog &middot; tomafro.net</title>
  <meta name="description" content="Personal blog of Tom Ward, in which he writes about ruby, rails and web development, as well as other random ephemera"/>
  <meta name="verify-v1" content="ADnFYWq1MeVbf8+qNPe/GZTvcEsDgOCgWTWrUIPakz8=" />
  <meta http-equiv="X-UA-Compatible" content="chrome=1" />
  <script type="text/javascript" src="http://use.typekit.com/brv6igt.js"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  <link rel="stylesheet" href="/css/style.css" type="text/css" />
  <link rel="alternate" type="application/atom+xml" href="http://tomafro.net/atom.xml" />
  <link rel="canonical" href="http://tomafro.net/3"/>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1103395-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script');
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 
          'http://www') + '.google-analytics.com/ga.js';
      ga.setAttribute('async', 'true');
      document.documentElement.firstChild.appendChild(ga);
    })();
  </script>
  
</head>
<body>  
  <div id="container">
    <header class="menubar">
      <a class="name" href="/">tomafro.net</a> &middot; <a href="/about">about</a> &middot; <a href="http://github.com/tomafro">on github</a> &middot; <a href="http://delicious.com/tomafro">on delicious</a> &middot; <a href="http://twitter.com/tomafro">on twitter</a> &middot; <a href="http://www.last.fm/user/tomafro">on last.fm</a>
    </header>
    <div id="main">
      
<article class="post">
  <div class="content"><h2 class="title"><a href="/2010/01/how-to-use-rails3-gems-now">How to easily use Rails 3 now</a></h2>
    <div class="update">
<h3>Update 10th February 2010:</h3>
The instructions below were useful earlier in the development cycle.  Now the <a href="http://weblog.rubyonrails.org/2010/2/5/rails-3-0-beta-release">beta gem has been released</a>, the process is much easier:


<div class="highlight"><pre>gem uninstall bundler
gem install tzinfo builder memcache-client rack rack-test rack-mount 
gem install erubis mail text-format thor bundler i18n
gem install rails --pre
</pre>
</div>

</div>


<p>Now that rails 3 is getting closer to release, I wanted to start playing around with it.  I've seen a few articles on getting it up and running, but they all seemed a little bit complicated.  To use rails 2.3.5 before its release, I just built the gems myself and installed them.  It turns out you can easily do the same with rails 3.</p>

<p>First, install rails main dependencies:</p>

<div class="highlight"><pre>gem install rake rack bundler
gem install arel --version 0.2.pre
</pre>
</div>


<p>Next, get the latest rails code from github, and install the rails gems.  There may be a few errors you can safely ignore:</p>

<div class="highlight"><pre>git clone git://github.com/rails/rails.git
<span class="nb">cd </span>rails
rake install
</pre>
</div>


<p>And bang, you can start your first rails 3 project:</p>

<div class="highlight"><pre>rails ~/apps/playground/rails3 
</pre>
</div>


<p>Your existing projects shouldn't be affected as rails is installed as a prerelease gem, but to be safe I'd recommend a tool like <a href="http://rvm.beginrescueend.com/">rvm</a> to switch to a clean set of gems.</p>

  </div>
  <div class="meta">
  <span class="author"><a href="http://tomafro.net">Tom Ward</a></span> &middot; 
  <span class="date"><a href="/2010/01">24th January 2010</a></span>
  <span class="tags"> &middot; <a href="/tags/ruby" rel="tag">ruby</a> &middot; <a href="/tags/rails" rel="tag">rails</a> &middot; <a href="/tags/rails3" rel="tag">rails3</a> &middot; <a href="/tags/gems" rel="tag">gems</a></span>
  </div>
</article>

<article class="post">
  <div class="content"><h2 class="title"><a href="/2010/01/tip-relative-paths-with-file-expand-path">Tip: Relative paths with File.expand_path</a></h2>
    <p>You probably know about the <code>__FILE__</code> magic constant.  It holds the filename of the currently executing ruby source file, relative to the execution directory.  So with the following saved as <code>/code/examples/path_example.rb</code>:</p>

<div class="highlight"><pre><span class="nb">puts</span> <span class="bp">__FILE__</span>
</pre>
</div>


<p>Running this file from the <code>/code</code> folder will output <code>examples/path_example.rb</code></p>

<p>This is often used to load files on paths relative to the current file.  The way I've used it before is like this:</p>

<div class="highlight"><pre><span class="n">config_path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">),</span> <span class="s2">&quot;config.yml&quot;</span><span class="p">))</span>
</pre>
</div>


<p>This works, but it's a bit clunky.</p>

<p>What I didn't realise until reading the rails source code the other day, is that <code>File.expand_path</code> can take a second argument - a starting directory.  Also, this argument doesn't actually have to be a path to a directory, it also accepts a path to a file.  With this knowledge we can shorten the above to the following:</p>

<div class="highlight"><pre><span class="n">config_path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">&quot;../config.yml&quot;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</pre>
</div>


<p>Much simpler.</p>

  </div>
  <div class="meta">
  <span class="author"><a href="http://tomafro.net">Tom Ward</a></span> &middot; 
  <span class="date"><a href="/2010/01">23rd January 2010</a></span>
  <span class="tags"> &middot; <a href="/tags/ruby" rel="tag">ruby</a> &middot; <a href="/tags/tip" rel="tag">tip</a> &middot; <a href="/tags/tiny" rel="tag">tiny</a> &middot; <a href="/tags/file" rel="tag">file</a> &middot; <a href="/tags/expand-path" rel="tag">expand-path</a></span>
  </div>
</article>

<article class="post">
  <div class="content"><h2 class="title"><a href="/2009/11/taking-screenshots-of-web-pages-with-macruby">Taking screenshots of web pages with macruby</a></h2>
    <p>Whilst playing around with the very exciting <a href="http://macruby.org">macruby</a> last weekend, I thought I'd try building a web page screenshot grabber, based on <a href="http://www.bencurtis.com/?p=128">Ben Curtis' code</a>.  The code was very easy to change translate from <code>rubycocoa</code>, looks cleaner and seems to work really well:</p>

<div class="highlight"><pre><span class="n">framework</span> <span class="s1">&#39;Cocoa&#39;</span>
<span class="n">framework</span> <span class="s1">&#39;WebKit&#39;</span>

<span class="k">class</span> <span class="nc">Snapper</span>
  <span class="kp">attr_accessor</span> <span class="ss">:options</span><span class="p">,</span> <span class="ss">:view</span><span class="p">,</span> <span class="ss">:window</span>
  
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@options</span> <span class="o">=</span> <span class="n">options</span>
    <span class="n">initialize_view</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">setFrameLoadDelegate</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
    <span class="c1"># Tell the webView what URL to load.</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">mainFrame</span>
    <span class="n">req</span> <span class="o">=</span> <span class="no">NSURLRequest</span><span class="o">.</span><span class="n">requestWithURL</span><span class="p">(</span><span class="no">NSURL</span><span class="o">.</span><span class="n">URLWithString</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">loadRequest</span> <span class="n">req</span>
    
    <span class="k">while</span> <span class="n">view</span><span class="o">.</span><span class="n">isLoading</span>  <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">timed_out?</span>
      <span class="no">NSRunLoop</span><span class="o">.</span><span class="n">currentRunLoop</span><span class="o">.</span><span class="n">runUntilDate</span> <span class="no">NSDate</span><span class="o">.</span><span class="n">date</span>
    <span class="k">end</span>
    
    <span class="k">if</span> <span class="vi">@failedLoading</span>
      <span class="nb">puts</span> <span class="s2">&quot;Failed to load page at: </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span>
      <span class="n">docView</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">mainFrame</span><span class="o">.</span><span class="n">frameView</span><span class="o">.</span><span class="n">documentView</span>
      <span class="n">docView</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">setContentSize</span><span class="p">(</span><span class="n">docView</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
      <span class="n">docView</span><span class="o">.</span><span class="n">setFrame</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
    
      <span class="n">docView</span><span class="o">.</span><span class="n">setNeedsDisplay</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
      <span class="n">docView</span><span class="o">.</span><span class="n">displayIfNeeded</span>
      <span class="n">docView</span><span class="o">.</span><span class="n">lockFocus</span>
    
      <span class="n">bitmap</span> <span class="o">=</span> <span class="no">NSBitmapImageRep</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFocusedViewRect</span><span class="p">(</span><span class="n">docView</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
      <span class="n">docView</span><span class="o">.</span><span class="n">unlockFocus</span>

      <span class="c1"># Write the bitmap to a file as a PNG</span>
      <span class="n">representation</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">.</span><span class="n">representationUsingType</span><span class="p">(</span><span class="no">NSPNGFileType</span><span class="p">,</span> <span class="n">properties</span><span class="ss">:nil</span><span class="p">)</span>
      <span class="n">representation</span><span class="o">.</span><span class="n">writeToFile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">atomically</span><span class="ss">:true</span><span class="p">)</span>
      <span class="n">bitmap</span><span class="o">.</span><span class="n">release</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
  <span class="kp">private</span>
  
  <span class="k">def</span> <span class="nf">webView</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">didFailLoadWithError</span><span class="ss">:error</span><span class="p">,</span> <span class="n">forFrame</span><span class="ss">:frame</span><span class="p">)</span>
    <span class="vi">@failedLoading</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">webView</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">didFailProvisionalLoadWithError</span><span class="ss">:error</span><span class="p">,</span> <span class="n">forFrame</span><span class="ss">:frame</span><span class="p">)</span>
    <span class="vi">@failedLoading</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">initialize_view</span>
    <span class="no">NSApplication</span><span class="o">.</span><span class="n">sharedApplication</span>    
    
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">WebView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">600</span><span class="o">]</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="no">NSWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithContentRect</span><span class="p">(</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">600</span><span class="o">]</span><span class="p">,</span>
      <span class="n">styleMask</span><span class="ss">:NSBorderlessWindowMask</span><span class="p">,</span> <span class="n">backing</span><span class="ss">:NSBackingStoreBuffered</span><span class="p">,</span> <span class="n">defer</span><span class="ss">:false</span><span class="p">)</span>
      
    <span class="n">window</span><span class="o">.</span><span class="n">setContentView</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>    
    <span class="c1"># Use the screen stylesheet, rather than the print one.</span>
    <span class="n">view</span><span class="o">.</span><span class="n">setMediaStyle</span><span class="p">(</span><span class="s1">&#39;screen&#39;</span><span class="p">)</span>
    <span class="c1"># Set the user agent to Safari, to ensure we get back the exactly the same content as </span>
    <span class="c1"># if we browsed directly to the page</span>
    <span class="n">view</span><span class="o">.</span><span class="n">setCustomUserAgent</span> <span class="s1">&#39;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_2; en-us)&#39;</span> <span class="o">+</span>
        <span class="s1">&#39;AppleWebKit/531.21.8 (KHTML, like Gecko) Version/4.0.4 Safari/531.21.10&#39;</span>
    <span class="c1"># Make sure we don&#39;t save any of the prefs that we change.</span>
    <span class="n">view</span><span class="o">.</span><span class="n">preferences</span><span class="o">.</span><span class="n">setAutosaves</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
    <span class="c1"># Set some useful options.</span>
    <span class="n">view</span><span class="o">.</span><span class="n">preferences</span><span class="o">.</span><span class="n">setShouldPrintBackgrounds</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">preferences</span><span class="o">.</span><span class="n">setJavaScriptCanOpenWindowsAutomatically</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">preferences</span><span class="o">.</span><span class="n">setAllowsAnimatedImages</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
    <span class="c1"># Make sure we don&#39;t get a scroll bar.</span>
    <span class="n">view</span><span class="o">.</span><span class="n">mainFrame</span><span class="o">.</span><span class="n">frameView</span><span class="o">.</span><span class="n">setAllowsScrolling</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">timed_out?</span>
    <span class="vi">@start</span> <span class="o">||=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
    <span class="p">(</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_i</span> <span class="o">-</span> <span class="vi">@start</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:timeout</span><span class="o">]</span> <span class="o">||</span> <span class="mi">30</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>To use:</p>

<div class="highlight"><pre><span class="n">macruby</span> <span class="o">-</span><span class="n">r</span> <span class="n">snapper</span><span class="o">.</span><span class="n">rb</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;Snapper.new.save(&#39;http://tomafro.net&#39;, &#39;tomafro.net.png&#39;)&quot;</span>
</pre>
</div>


<p>The next step is to add some command line options, then try compilation and deployment with <code>macrubyc</code> and <code>macruby_deploy</code></p>

  </div>
  <div class="meta">
  <span class="author"><a href="http://tomafro.net">Tom Ward</a></span> &middot; 
  <span class="date"><a href="/2009/11">30th November 2009</a></span>
  <span class="tags"> &middot; <a href="/tags/macruby" rel="tag">macruby</a> &middot; <a href="/tags/screenshots" rel="tag">screenshots</a> &middot; <a href="/tags/web" rel="tag">web</a> &middot; <a href="/tags/osx" rel="tag">osx</a></span>
  </div>
</article>

<article class="post">
  <div class="content"><h2 class="title"><a href="/2009/11/zoom-keyboard-shortcut-for-os-x">Tip: Zoom keyboard shortcut for OS X</a></h2>
    <p>In the Terminal run:</p>

<div class="highlight"><pre>defaults write NSGlobalDomain NSUserKeyEquivalents <span class="s1">&#39;{&quot;Zoom&quot; = &quot;@^Z&quot;; &quot;Zoom Window&quot; = &quot;@^Z&quot;; }&#39;</span>
</pre>
</div>


<p>Quit and relaunch your applications, and <span class='osx-shortcut'>⌃⌘Z</span> should zoom and unzoom.</p>

<p>Stolen from <a href="http://www.macosxhints.com/article.php?story=20051227001809626">macoshints.com</a>, posted here for my own benefit.</p>

  </div>
  <div class="meta">
  <span class="author"><a href="http://tomafro.net">Tom Ward</a></span> &middot; 
  <span class="date"><a href="/2009/11"> 6th November 2009</a></span>
  <span class="tags"> &middot; <a href="/tags/tip" rel="tag">tip</a> &middot; <a href="/tags/osx" rel="tag">osx</a> &middot; <a href="/tags/keyboard" rel="tag">keyboard</a> &middot; <a href="/tags/shortcut" rel="tag">shortcut</a> &middot; <a href="/tags/zoom" rel="tag">zoom</a> &middot; <a href="/tags/tiny" rel="tag">tiny</a></span>
  </div>
</article>

<article class="post">
  <div class="content"><h2 class="title"><a href="/2009/11/building-gems-from-a-rails-branch">Building rails gems from the 2-3-stable branch</a></h2>
    <p>For the latest application I've been working on, I wanted to use <a href="http://github.com/NZKoz/rails_xss/">Michael Koziarski's rails_xss plugin</a>, to turn default escaping on in my erb templates.  I'm also using <a href="http://github.com/wycats/bundler/">wycats gem bundler</a> to manage gems and their dependencies, including rails.</p>

<p>This posed a problem: xss_rails requires changes made in rails 2-3-stable branch, but not yet released in a gem (though they will be included in 2.3.5).</p>

<p>The solution was obvious: build my own gems, and get bundler to use them.  Luckily, rails makes this an easy process.</p>

<p>First, clone rails from github, and change to the 2-3-stable branch:</p>

<div class="highlight"><pre>git clone git://github.com/rails/rails.git
<span class="nb">cd </span>rails
git co -b 2-3-stable origin/2-3-stable
</pre>
</div>


<p>Next, we need to build the gems.  Rails currently doesn't seem to have a Raketask to build all its constituent projects (though I'm planning a patch to include one), so you have to build each one in turn:</p>

<div class="highlight"><pre><span class="nb">cd </span>actionmailer
rake gem <span class="nv">PKG_BUILD</span><span class="o">=</span>1
<span class="nb">cd</span> ../actionpack
rake gem <span class="nv">PKG_BUILD</span><span class="o">=</span>1
<span class="nb">cd</span> ../activerecord
rake gem <span class="nv">PKG_BUILD</span><span class="o">=</span>1
<span class="nb">cd</span> ../activeresource
rake gem <span class="nv">PKG_BUILD</span><span class="o">=</span>1
<span class="nb">cd</span> ../activesupport
rake gem <span class="nv">PKG_BUILD</span><span class="o">=</span>1
<span class="nb">cd</span> ../railties
rake gem <span class="nv">PKG_BUILD</span><span class="o">=</span>1
<span class="nb">cd</span> ..
</pre>
</div>


<p>The key is the <code>PKG_BUILD</code> variable.  It appends a suffix to the rails version, so rather than building 2.3.4 (the version I checked out), it will build 2.3.4.1.  If I decided to update my gems, I'd use PKG_BUILD=2, then 3 and so on.</p>

<p>Finally, once all these gems are built, it's simply a case of finding them and using them.  For gem bundler, this means placing them in the cache and updating the Gemfile to look for rails '2.3.4.1'.  The gems are all built in pkg folders in their respective subprojects, so to copy them all somewhere else you can run:</p>

<div class="highlight"><pre>cp **/pkg/*.gem &lt;project-folder&gt;/gems/cache
</pre>
</div>




  </div>
  <div class="meta">
  <span class="author"><a href="http://tomafro.net">Tom Ward</a></span> &middot; 
  <span class="date"><a href="/2009/11"> 5th November 2009</a></span>
  <span class="tags"> &middot; <a href="/tags/ruby" rel="tag">ruby</a> &middot; <a href="/tags/rails" rel="tag">rails</a> &middot; <a href="/tags/gem" rel="tag">gem</a> &middot; <a href="/tags/bundler" rel="tag">bundler</a></span>
  </div>
</article>

    </div>
  </div>
</body>	
</html>